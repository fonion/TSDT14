%% generate noise

x = randn(2^10, 1);

%% filter low degree

R0 = 1;
a = 0.9;
N = 2^10;

theta = linspace(0,1,N);

H1 = 1 ./ (1 - a* exp(-1i * 2 * pi .* theta));

%% PSD low degree

Ry1 = (R0./(1+a^2-2*a.*cos(2*pi.*theta)));

figure(8)
plot(theta, Ry1);
title('PSD low degree filter')
xlabel('Theta')
ylabel('Power Spectral Density')

%% ACF low degree

n1 = linspace((-N/2), (N/2), N+1);
n2 = linspace(-20, 20, 41);

ry11 = (R0/(1-a^2)).*a.^abs(n1); %intervall alla n
ry12 = (R0/(1-a^2)).*a.^abs(n2); %intervall -20 till 20

figure(2)
subplot(121)
plot(n1, ry11)
title('ACF lowdegree filter för alla n')
xlabel('sampels')
ylabel('Auto Correlation Function')

subplot(122)
stem(n2, ry12)
title('ACF lowdegree filter -20 <n< 20')
xlabel('sampels')
ylabel('Auto Correlation Function')

 

%% Idealt filter

 

theta0 = 0.1;
H2 = (1/theta0)*rectangularPulse(theta/theta0);

%plot(theta, H2)

%% PSD idealt

Ry2 = R0/(theta0^2).*rectangularPulse(theta/theta0);
%spegla en också!!!
Ry2 = Ry2 + R0/(theta0^2).*rectangularPulse((theta - 1)/theta0);

figure(2)
plot(theta, Ry2)
axis([0 1 0 150])
title('PSD idealt filter')
xlabel('Theta')
ylabel('Power Spectral Density')

%% ACF idealt

n1 = linspace((-N/2), (N/2), N+1);
n22 = linspace(-20, 20, 41);

ry21 = R0/(theta0)*sinc(theta0*n1); %intervall alla n
ry22 = R0/(theta0)*sinc(theta0*n22); %intervall -20 till 20

 
figure(1)
subplot(121)
plot(n1, ry21)
title ('ACF Idealt filter alla n');
title('ACF lowdegree filter för alla n')
xlabel('sampels')
ylabel('Auto Correlation Function')


subplot(122)
stem(n22, ry22)
title ('ACF Idealt filter -20 < n < 20');
xlabel('sampels')
ylabel('Auto Correlation Function')

%% ESTIMATION
%
%
%

%% 
%
%Low degree fiter 
%
%
%%
n3 = linspace((-N/2), (N/2), N);
n4 = linspace(-20, 20, 41);
bf = 1;
af = [1;-a];
outputh1 = filter(bf,af,x);

ACFh1 = ACF_estimation(outputh1, 'bartlett');
%% Plot ACF Low degree
figure(1)
subplot(121)
plot(n3, ACFh1)
title('estimate ACF, all n')


subplot(122)
stem(n4, ACFh1(492:(492+40)))
title('estimate ACF, -20 < n < 20')

%% Estimate PSD low degree raw

PSDh1 = abs((fft(ACFh1)));

figure(3)
plot(theta, PSDh1);
title('PSD low degree filter')

%% Smoothing av estimated PSD Blackman
% ACFh1 = ACFh1';
% windowsize = length(ACFh1');
% 
% blackmanw = blackman(windowsize);
% blackACF = real(blackmanw .* ACFh1);

%%
% BlackmanW = fft(blackmanw);
% blackPSD = abs(conv(BlackmanW, PSDh1));
% thetablack = linspace(0, 1, 1024+windowsize-1);
% 
% figure(2)
% plot(thetablack, blackPSD);

%% Periodogram = PSD för low degree.
figure(4)
PSDgram = fftshift(pgram(ACFh1));

plot(theta, PSDgram)

%% averaging på periodogram PSD aver1
intervals = 2^6;
PSDaver1 = averageper(outputh1,intervals);

figure(3);
thetaaver = linspace(0,1,N/intervals + 1);
plot(thetaaver, (abs(PSDaver1)));
axis([0 1 0 1]);
title('PSDaver1')
%% smoothing på averaging PSD averwindow!

ACFaver1 = ifft(PSDaver1);
window = blackman(length(ACFaver1))';
ACFaver1window = window .* ACFaver1;
PSDaver1window = abs(fft (ACFaver1window));
plot(thetaaver, PSDaver1window);
axis([0 1 0 1]);
%% plot ACFaver1window
% n5 = linspace (-(N/2), (N/2), 17);
% 
% subplot(121)
% plot(n5, ACFaver1window)
% title('estimate ACF, all n')
%subplot(121)
%stem(n4, ACfaver1window(492:(492+40)))

%% smoothing på ACF

window = blackman(length(ACFh1));
ACFh1window = window .* ACFh1;

figure(3)
subplot(121)
plot(n3, ACFh1window)
title('smoothing ACF, all n')


subplot(122)
stem(n4, ACFh1window(492:(492+40)))
title('smoothing ACF, -20 < n < 20')
%% averaging ACF1
averinterval = 6;
avertemp = averageper(outputh1,averinterval);
ACFaver1 = ifft(avertemp);
n5 = linspace(-N/2 , N/2 , max(size(ACFaver1)));
figure(6)
plot(n5, ACFaver1)
title('averaging ACF, all n')


% subplot(122)
% stem(n4, ACFaver1)
% title('averaging ACF, -20 < n < 20')

%% smoothing på aver ACF

window = blackman(length(ACFaver1));
ACFaver1window = window .* ACFaver1;

figure(3)
subplot(121)
plot(n3, ACFaver1window)
title('smoothing ACF, all n')


%% 
%
%
% Ideal filter
%
%

%%

[b a] = butter(10, 0.1);
outputh2 = filter(b, a, x);

ACFh2 = ACF_estimation(outputh2, 'bartlett');

%% Plot Ideal

figure(2)
subplot(121)
plot(n3, ACFh2)
title('estimate ACF, all n')


subplot(122)
stem(n4, ACFh2(492:(492+40)))
title('estimate ACF, -20 < n < 20')

%% Periodogram = PSD för Ideal. raw estimate

PSDgram2 = pgram(ACFh2);

figure(1)
plot(theta, PSDgram2)


%% Smoothing av estimated PSD Blackman

windowsize = 3;
blackmanw = blackman(windowsize);
%blackACF = BlackmanW*ACFh1;
BlackmanW = fft(blackmanw);
blackPSD2 = abs(conv(BlackmanW, PSDgram2));
thetablack = linspace(0, 1, 1024+windowsize-1);

figure(2)
plot(thetablack, blackPSD2);

%% averaging på periodogram
thetaaver = linspace(0,1,N/intervals + 1);

intervals = 45;
PSDaver2 = averageper(outputh2,intervals);

figure(1);
plot(thetaaver, fftshift(abs(PSDaver2)));
title('PSDaver2')

%%

figure(300)
plot()
 